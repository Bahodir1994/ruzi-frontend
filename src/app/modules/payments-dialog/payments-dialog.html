<p-dialog
  #dlg
  [(visible)]="visible"
  [modal]="true"
  [draggable]="false"
  [closable]="true"
  [maximizable]="true"
  appendTo="body"
  header="To‘lov"
  (onShow)="maximizeOnOpen()"
  (onHide)="onHide()">
  <div class="grid grid-cols-12">
    <div class="col-span-7">
      <div class="px-2 pb-2">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <div class="field-label">Jami summa</div>

          <div class="flex items-center gap-3 flex-wrap justify-end">

            <!-- To'lov turi preview -->
            <p-tag [value]="paymentTypePreview" severity="info" class="text-xs"></p-tag>

            <!-- Jami -->
            <div class="text-2xl font-semibold whitespace-nowrap">
              {{ total | number:'1.0-2' }} so‘m
            </div>

            <!-- ajratuvchi chiziq (md+ da) -->
            <span class="hidden md:inline-block w-px h-6 bg-surface-300"></span>

            <!-- To'langan -->
            <div class="summary-chip flex items-center gap-1 whitespace-nowrap">
              <span class="opacity-70 text-sm">To‘langan:</span>
              <b class="text-emerald-600">{{ paid | number:'1.0-2' }} so‘m</b>
            </div>

            <!-- Qaytim -->
            <div class="summary-chip flex items-center gap-1 whitespace-nowrap"
                 [ngClass]="{'text-green-700': change>0}">
              <span class="opacity-70 text-sm">Qaytim:</span>
              <b>{{ change | number:'1.0-2' }} so‘m</b>
            </div>

            <!-- Qarz -->
            <div class="summary-chip flex items-center gap-1 whitespace-nowrap"
                 [ngClass]="{'text-red-700': debt>0}">
              <span class="opacity-70 text-sm">Qarz:</span>
              <b>{{ debt | number:'1.0-2' }} so‘m</b>
            </div>
          </div>
        </div>

        @if (debt>0 && !hasCustomer) {
          <div class="text-xs text-red-600 mt-1">
            Qarzga berish uchun savatga mijoz biriktirilishi shart.
          </div>
        }
      </div>
      <p-divider class="my-0"></p-divider>

      <p-divider class="my-0"></p-divider>

      <div class="space-y-2">
        @for (r of rows; track i; let i = $index) {
          <div class="row-card border"
               [ngClass]="{'ring-2 ring-primary-400': i===activeIndex}"
               (click)="setActive(i)">
            <div class="flex items-center gap-2 flex-wrap">
              <!-- Method -->
              <p-selectButton [options]="methodOptions" [(ngModel)]="r.method" [allowEmpty]="false"></p-selectButton>

              <!-- Amount -->
              <p-inputNumber
                [(ngModel)]="r.amount" [min]="0" [mode]="'currency'" [currency]="'UZS'"
                [inputStyle]="{'text-align':'right'}"
                class="w-40 md:w-56"
                (onInput)="recalc()"
                placeholder="0,00 UZS">
              </p-inputNumber>
              <!-- Txn -->
              <input
                pSize="small"
                type="text"
                pInputText [(ngModel)]="r.externalTxnId"
                placeholder="Terminal chek raqami (ixtiyoriy)"
                class="p-inputtext p-component text-xs w-48 md:w-56"/>

              <!-- Terminal (faqat karta) -->
              @if (r.method==='CARD') {
                <p-button
                  size="small" severity="secondary" type="button"
                  icon="pi pi-credit-card" label="Terminaldan olish"
                  [loading]="!!r.loading" (click)="requestFromTerminal(i)">
                </p-button>
              }

              <!-- Qolganini to'ldir -->
              <span class="action-chip" (click)="fillRemainder(i)" pTooltip="Qolgan summani shu qatorda to‘ldirish">
                Qolganini to‘ldir
              </span>

              <!-- O'chirish -->
              @if (rows.length > 1) {
                <p-button severity="danger" size="small" [text]="true" icon="pi pi-times"
                          class="ml-auto" (click)="removeRow(i)"></p-button>
              }
            </div>
          </div>
        }
      </div>
      <div class="flex gap-2 mt-3 flex-wrap">
        <p-button size="small" label="Qator qo‘shish" icon="pi pi-plus" (click)="addRow()"></p-button>
        <p-button size="small" label="50/50 bo‘lish" (click)="split50()"></p-button>
        <p-button size="small" label="Hammasi naqd" (click)="allCash()"></p-button>
        <p-button size="small" label="Hammasi karta" (click)="allCard()"></p-button>
      </div>
    </div>
    <p-divider layout="vertical" styleClass="p-0 m-0"/>
    <div class="col-span-4">
      <div class="w-full">
        <div class="field-label mb-2">Sensor klaviatura (faol qator: {{activeIndex + 1}})</div>
        <!-- Kalkulyator 4 ustun (3x3 + servislar) -->
        <div class="grid grid-cols-4 gap-2">
          <!-- 7 8 9 ⌫ -->
          <p-button styleClass="w-full h-24" [style]="{fontSize: '28px'}" label="7" (click)="appendDigit('7')"></p-button>
          <p-button styleClass="w-full h-24" [style]="{fontSize: '28px'}" label="8" (click)="appendDigit('8')"></p-button>
          <p-button styleClass="w-full h-24" [style]="{fontSize: '28px'}" label="9" (click)="appendDigit('9')"></p-button>
          <p-button styleClass="w-full h-24" [style]="{fontSize: '28px'}" (click)="backspace()" severity="secondary">
            <i class="pi pi-delete-left"></i>
          </p-button>


          <!-- 4 5 6 +10k -->
          <p-button styleClass="w-full h-24" [style]="{fontSize: '28px'}" label="4" (click)="appendDigit('4')"></p-button>
          <p-button styleClass="w-full h-24" [style]="{fontSize: '28px'}" label="5" (click)="appendDigit('5')"></p-button>
          <p-button styleClass="w-full h-24" [style]="{fontSize: '28px'}" label="6" (click)="appendDigit('6')"></p-button>
          <p-button styleClass="w-full h-24" [style]="{fontSize: '28px'}" label="+10k" (click)="addCash(10000)" severity="success"></p-button>

          <!-- 1 2 3 +50k -->
          <p-button styleClass="w-full h-24" [style]="{fontSize: '28px'}" label="1" (click)="appendDigit('1')"></p-button>
          <p-button styleClass="w-full h-24" [style]="{fontSize: '28px'}" label="3" (click)="appendDigit('3')"></p-button>
          <p-button styleClass="w-full h-24" [style]="{fontSize: '28px'}" label="2" (click)="appendDigit('2')"></p-button>
          <p-button styleClass="w-full h-24" [style]="{fontSize: '28px'}" label="+50k" (click)="addCash(50000)" severity="success"></p-button>

          <!-- 00 0 C +100k -->
          <p-button styleClass="w-full h-24" [style]="{fontSize: '28px'}" label="00" (click)="append00()" severity="secondary"></p-button>
          <p-button styleClass="w-full h-24" [style]="{fontSize: '28px'}" label="0" (click)="appendDigit('0')"></p-button>
          <p-button styleClass="w-full h-24" [style]="{fontSize: '28px'}" label="C" (click)="clearActive()" severity="danger"></p-button>
          <p-button styleClass="w-full h-24" [style]="{fontSize: '28px'}" label="+100k" (click)="addCash(100000)" severity="success"></p-button>
        </div>
        <!-- Kupyura tez tugmalar: 3 ustunli zich grid -->
        <div class="mt-1">
          <div class="grid grid-cols-3 gap-1.5">
            @for (amt of cashPad; track amt) {
              <p-button
                [outlined]="true"
                size="small"
                styleClass="w-full"
                [label]="(amt | number:'1.0-0') + ' so‘m'"
                (click)="addCash(amt)"
              />
            }
            <p-buttonGroup class="w-full col-span-2">
              <p-button size="small" class="w-full" severity="danger" label="−10k"  (click)="subCash(10000)"></p-button>
              <p-button size="small" class="w-full" severity="danger" label="−50k"  (click)="subCash(50000)"></p-button>
              <p-button size="small" class="w-full" severity="danger" label="−100k" (click)="subCash(100000)"></p-button>
            </p-buttonGroup>
          </div>
          <small class="hint block">
            Hotkeys: F8=+10k · F9=+20k · F5=+50k · F6=+100k · F7=+200k · Ctrl+0=tozalash · Raqamlar=qo‘shish
          </small>
        </div>
      </div>
    </div>
  </div>
  <ng-template #footer>
    <div class="w-full">
      <p-divider class="my-0 py-0"></p-divider>
      <!-- 3 ustunli grid: chap = bonus, o'rtada = tugmalar, o'ng = bo'sh (center saqlash uchun) -->
      <div class="px-3 grid grid-cols-3 items-center gap-3">
        <!-- Chap: Bonus % -->
        <div class="justify-self-start" (click)="handleRefPercentClick()">
          <div class="field-label mb-1">Xamkor bonus %</div>
          <p-inputNumber
            [(ngModel)]="refPercent"
            [min]="0" [max]="100"
            [mode]="'decimal'"
            [minFractionDigits]="0" [maxFractionDigits]="2"
            class="w-28"
            [disabled]="!hasReferrer"
            (onInput)="onRefPercentInput()">
          </p-inputNumber>

          @if (!hasReferrer) {
            <small class="hint block text-amber-600">Xamkor biriktirilmagan — bonus 0%</small>
          } @else {
            <small class="hint block">Bonus cheki bo‘yicha umumiy summadan hisoblanadi</small>
          }
        </div>
        <!-- Markaz: Actions -->
        <div class="justify-self-center flex items-center gap-2">
          <button
            pButton
            label="Bekor qilish"
            class="p-button-text"
            (click)="visible=false">
          </button>

          <button
            pButton
            label="Tasdiqlash"
            icon="pi pi-check"
            [disabled]="!canConfirm()"
            (click)="confirm()">
          </button>
        </div>
        <!-- O'ng ustun bo'sh: center’ni ushlab turish uchun -->
        <div></div>
      </div>
      <p-divider class="my-0 py-0"></p-divider>
      <!-- Hotkeys -->
      <div class="px-3 text-center text-xs opacity-70">
        <i class="pi pi-keyboard mr-1"></i>
        F2 — Naqd qatori · F3 — Karta qatori · F4 — 50/50 · F5/6/7/8/9 — kupyuralar · ⏎ Enter — tasdiqlash · Esc — yopish
      </div>
    </div>
  </ng-template>
</p-dialog>

<p-toast></p-toast>
