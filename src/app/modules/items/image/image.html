<p-card
  class="card pt-0 mt-0"
  (dragover)="onDragOver($event)"
  (dragleave)="onDragLeave($event)"
  (drop)="onDrop($event)"
>
  <ng-template #title>
    Rasmlar kutubxonasi: {{ selectedImages.length }}/{{ filteredImages.length }}/{{ imagesList.length }}
  </ng-template>
  <ng-template #subtitle>
    <div class="flex items-center justify-between w-full mt-0 pt-0">
      <div class="text-sm">
        Barcha ob'ektlaringiz tasvirlarini boshqaring.
        <br/>
        Yuklash uchun rasmlarni ushbu sahifaga sudrab tashlang yoki to‘g‘ridan-to‘g‘ri qurilmangizdan yuklang.
      </div>
      @if (imagesList.length > 0) {
        <div class="flex items-center gap-2">
          <span class="p-input-icon-left">
            <input
              type="search"
              pInputText
              [(ngModel)]="searchQuery"
              placeholder="Qidiruv..."
              (input)="applyFilters()"
            />
          </span>
          <p-select
            [options]="sortOptions"
            [(ngModel)]="selectedSort"
            placeholder="Saralash..."
            optionLabel="label"
            class="w-40"
            (onChange)="applyFilters()"
          ></p-select>
          <p-button
            pTooltip="Barchasini tanlash / bekor qilish"
            [tooltipPosition]="'bottom'"
            [icon]="isAllSelected() ? 'pi pi-times' : 'pi pi-check-square'"
            severity="info"
            (click)="toggleSelectAll()"
          ></p-button>
          <p-button
            [disabled]="selectedImages.length == 0"
            pTooltip="Tanlanganlarni o‘chirish"
            [tooltipPosition]="'bottom'"
            icon="pi pi-trash"
            severity="danger"
            (click)="removeSelectedImages()"
          ></p-button>
          <p-fileupload
            name="images"
            mode="basic"
            [customUpload]="true"
            [showUploadButton]="false"
            [showCancelButton]="false"
            (uploadHandler)="onUpload($event)"
            [multiple]="true"
            [auto]="true"
            accept="image/*"
            chooseLabel="Fayllarni tanlash"
            chooseIcon="pi pi-folder-open"
          >
          </p-fileupload>
          <input
            #folderInput
            type="file"
            multiple
            accept="image/*"
            class="hidden"
            (change)="onFolderSelect($event)"
          />
        </div>
      }
    </div>
  </ng-template>
  @if (isLoading) {
    <div
      class="absolute inset-0 flex flex-col items-center justify-center"
    >
      <p-progressSpinner></p-progressSpinner>
    </div>
  } @else if (imagesList.length === 0) {
    <div
      class="relative flex flex-col items-center justify-center border-2 border-dashed rounded-2xl p-20 text-center transition-all duration-200"
      [class.border-blue-500]="isDraggingOver"
      [class.bg-blue-50]="isDraggingOver"
      (dragover)="onDragOver($event)"
      (dragleave)="onDragLeave($event)"
    >
      <img ngSrc="assets/images/icons/digital-camera.png" width="200" height="200" alt="icon"/>
      <p class="text-lg font-semibold text-gray-600">
        Rasmlarni ko‘tarib tashlang yoki yuklang
      </p>

      <p-fileupload
        name="images"
        mode="basic"
        [auto]="true"
        [customUpload]="true"
        [showUploadButton]="false"
        [showCancelButton]="false"
        (uploadHandler)="onUpload($event)"
        [multiple]="true"
        accept="image/*"
        chooseLabel="Fayl tanlash"
        chooseIcon="pi pi-upload"
        styleClass="mt-3 text-blue-600 underline"
      />
    </div>
  } @else {
    <p-scrollPanel [style]="{ width: '100%', height: '75vh' }">
      <div class="mt-6 flex flex-wrap gap-6">
        @for (img of filteredImages; track img.id) {
          <div
            class="relative w-28 h-28 rounded-lg overflow-hidden border group shadow-sm hover:shadow-md transition-all duration-200 bg-gray-50"
            (click)="toggleSelection(img)"
          >
            <div
              class="absolute top-0 left-0 z-10 bg-white/90 rounded-md p-1 shadow-sm cursor-pointer"
              (click)="$event.stopPropagation(); toggleSelection(img)"
            >
              <p-checkbox
                binary="true"
                [ngModel]="isSelected(img)"
                [style]="{ transform: 'scale(0.9)' }"
              ></p-checkbox>
            </div>

            <img
              ngSrc="{{ imagePathPrefix + img.parentId + '/' + img.docName }}"
              fill
              alt="{{ img.docName }}"
              decoding="async"
              class="p-2 object-cover w-full h-full transition-transform duration-200 group-hover:scale-105"
            />

            <div
              class="absolute inset-0 flex items-center justify-center gap-3 opacity-0 group-hover:opacity-100 transition-all duration-200 bg-black/40">
              <button
                type="button"
                class="border border-red-500 text-red-500 rounded-full w-10 h-10 flex items-center justify-center
                 hover:bg-red-500 hover:text-white transition-colors duration-150"
                (click)="$event.stopPropagation(); removeImage(img.id)"
                pTooltip="O‘chirish"
                tooltipPosition="top"
              >
                <i class="pi pi-trash text-lg"></i>
              </button>

              <button
                type="button"
                class="border border-sky-500 text-sky-500 rounded-full w-10 h-10 flex items-center justify-center
                 hover:bg-sky-500 hover:text-white transition-colors duration-150"
                pTooltip="Tahrirlash"
                tooltipPosition="top"
                (click)="$event.stopPropagation(); dialog.maximize(); openEditModal(img)"
              >
                <i class="pi pi-pencil text-lg"></i>
              </button>
            </div>
            <div
              class="absolute bottom-0 left-0 w-full bg-black/70 text-white text-md text-center py-1 truncate group-hover:bg-white/0"
              title="{{ img.docName }}"
            >
              {{ img.docName }}
            </div>

            @if (isSelected(img)) {
              <div class="absolute inset-0 border-4 border-sky-500 rounded-lg pointer-events-none"></div>
            }
          </div>
        }
      </div>
    </p-scrollPanel>
  }
</p-card>

<p-dialog
  #dialog
  header="O‘zgartirish"
  [(visible)]="editDialogVisible"
  [modal]="true"
  [maximizable]="true"
  [closable]="true"
  [dismissableMask]="true"
  [draggable]="false"
  [resizable]="false"
>
  <ng-template #header>
    <div class="grid grid-cols-[auto,1fr,auto] items-center gap-3 w-full">

      <div class="flex items-center gap-2">
        <form [formGroup]="formSaveEditedImage" (ngSubmit)="saveEditedImage()" class="flex items-center gap-2">
          <p-button type="submit" label="Saqlash" severity="primary"></p-button>
        </form>

        <p-menu
          #menu
          [model]="actions"
          [popup]="true"
          (onHide)="menuVisible = false"
          styleClass="rounded-lg shadow-md"
          appendTo="body"
        ></p-menu>

        <p-button
          (click)="toggleMenu($event, menu)"
          label="Amallar"
          [icon]="menuVisible ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"
          iconPos="right"
          severity="info"
          variant="outlined"
          class="rounded-md"
        ></p-button>
      </div>

      <div class="justify-self-center text-center">
        <span class="text-2xl font-semibold">Rasmni o‘zgartirish</span>
      </div>

      <div class="justify-self-end"></div>
    </div>
  </ng-template>

  <div class="flex justify-center items-start">
    <div class="w-full max-w-4xl p-6">
      <form [formGroup]="formSaveEditedImage" class="flex flex-col gap-4" (ngSubmit)="saveEditedImage()">
        <div>
          <label class="block text-sm font-medium mb-1">Nomi</label>
          <input
            [pAutoFocus]="true"
            type="text"
            formControlName="name"
            name="docName"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"
          />

          @if (formSaveEditedImage.get('name')?.touched && formSaveEditedImage.get('name')?.invalid) {
            <small class="text-red-500 text-xs">
              @if (formSaveEditedImage.get('name')?.errors?.['required']) {
                Saqlash uchun nom bo‘sh bo‘lishi mumkin emas.
              } @else if (formSaveEditedImage.get('name')?.errors?.['maxlength']) {
                Nom 200 belgidan oshmasin.
              } @else if (formSaveEditedImage.get('name')?.errors?.['pattern']) {
                Faqat harf, raqam, _, - va bo‘sh joylarga ruxsat berilgan.
              }
            </small>
          }
        </div>
        <!-- Preview image -->
        <div class="border rounded-lg p-3 flex justify-center">
          <img
            [src]="imagePathPrefix + editImageData.parentId + '/' + editImageData.docName"
            [alt]="editImageData.altText"
            class="rounded-lg max-h-80 object-contain"
          />
        </div>
        <div class="text-center border-b-2 ">
          <span class="text-xl">{{ editImageData.docName }}</span>
        </div>
      </form>
    </div>
  </div>
</p-dialog>

