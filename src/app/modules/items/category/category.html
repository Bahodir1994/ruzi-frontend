<p-card class="card" xmlns="http://www.w3.org/1999/html">
  <ng-template #header>
    <p class="text-3xl font-bold px-4 pt-2">Guruhlar</p>
    @if(categoryModel.length > 0){
      <div class="flex w-full justify-between gap-2 p-4">
        <p-icon-field iconPosition="right" class="pr-2">
          <p-inputicon class="pi pi-search"></p-inputicon>
          <input
            type="text"
            pInputText
            placeholder="Qidiruv"
            [(ngModel)]="searchValue"
            (input)="loadDataTable()"
          />
        </p-icon-field>
        <p-button
          *kaHasRoles="['ROLE_CAT_CREATE']"
          class="pr-2"
          styleClass="shadow shadow-blue-500/50"
          icon="pi pi-file-plus"
          label="Yangi kategoriya qo'shish"
          (onClick)="dialog.maximize()"
          (click)="showModalCategory = true"
        />
      </div>
    }
  </ng-template>
  @if(categoryModel.length === 0){
      <div
        class="relative flex flex-col items-center justify-center border rounded px-20 py-28 text-center transition-all duration-200 mt-0"
      >
        <i class="pi pi-folder mb-3 text-gray-500" style="font-size: 4rem;"></i>
        <p class="text-2xl font-bold">
          Tovarlar guruhi
        </p>
        <span class="text-sm max-w-2xl">Guruhlar mahsulotlaringizni tartibga solishga, mijozlar Ushbu platformada qanday harakat qilishini aniqlashga, mahsulot sotuvi haqida hisobot berishga va elementlarni muayyan printerlarga yoâ€˜naltirishga yordam beradi.</span>
        <p-button
          *kaHasRoles="['ROLE_CAT_CREATE']"
          class="p-2"
          styleClass="shadow shadow-blue-500/50"
          icon="pi pi-file-plus"
          label="Yangi guruh qo'shish"
          (onClick)="dialog.maximize()"
          (click)="showModalCategory = true"
        />
      </div>
  } @else {
    <p-table
    size="small"
    #dataTableCategory
    [value]="categoryModel"
    dataKey="id"
    [rowHover]="true"
    [rows]="10"
    [showCurrentPageReport]="true"
    [rowsPerPageOptions]="[10, 25, 50]"
    loadingIcon="pi pi-spinner"
    [paginator]="true"
    currentPageReportTemplate="{totalPages} ta dan {currentPage}-saxifa, jami {totalRecords} ta dan {first}-{last} gacha"
    [filterDelay]="0"
    [globalFilterFields]="['orderNumber','supplier.name','warehouse.name']"
    (onFilter)="onFilter($event)"
    (onSort)="onSort($event)"
    [scrollable]="true"
    [totalRecords]="totalRecords"
    [lazy]="true"
    (onLazyLoad)="pageChange($event)"
    [first]="0"
    [pageLinks]="5"
    [showJumpToPageInput]="true"
    scrollHeight="650px"
    class=""
  >
    <ng-template pTemplate="body" let-item let-i="rowIndex">
      <tr>
        <td>
          <div class="grid grid-cols-12 gap-4 p-2 grid-nogutter">
            <div class="col-span-12">
              <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                <div class="md:w-40 relative">
                  <img
                    class="block xl:block mx-auto rounded-border w-full"
                    [src]="item.primaryImageUrl"
                    [alt]="item.name"
                  />
                  <p-tag
                    [value]="item.code"
                    [severity]="'success'"
                    class="absolute dark:!bg-surface-900"
                    [style.left.px]="4"
                    [style.top.px]="4"
                  />
                </div>
                <div class="flex flex-col md:flex-row justify-between md:items-center flex-1 gap-6">
                  <div class="flex flex-row md:flex-col justify-between items-start gap-2">
                    <div>
                      <span class="font-medium text-secondary text-sm">{{ item.code }}</span>
                      <div class="text-lg font-medium text-surface-900 dark:text-surface-0 mt-2">{{ item.code }}</div>
                    </div>
                  </div>
                  <div class="flex flex-col md:items-end gap-8">
                    <div class="flex flex-row-reverse md:flex-row gap-2">
                      <span class="text-xl font-semibold text-surface-900 dark:text-surface-0">{{ item.items.length }}
                        ta tovar</span>
                      <p-button
                        size="small"
                        icon="pi pi-shopping-cart"
                        class="flex-auto md:flex-initial whitespace-nowrap"
                        label="qo'shish"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="6" class="text-center">Kategoriya topilmadi</td>
      </tr>
    </ng-template>
  </p-table>
  }
</p-card>

<p-dialog
  [(visible)]="showModalCategory"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [closable]="true"
  [maximizable]="true"
  [dismissableMask]="true"
  [style]="{ minWidth: '50rem'}"
  #dialog
  [baseZIndex]="10000">
  <ng-template #header>
    <div class="grid grid-cols-[auto,1fr,auto] items-center gap-3 w-full">
      <div class="flex items-center gap-2">
        <form [formGroup]="form" (ngSubmit)="onSubmit()" class="contents">
        <p-button type="submit" label="Saqlash" severity="primary"></p-button>
      </form>
        <div class="justify-self-end flex items-center gap-2 ml-2">
          <p-menu #menu [model]="actions" [popup]="true" appendTo="body" styleClass="rounded-lg shadow-md">
            <ng-template pTemplate="item" let-item>
              <a
                pRipple
                class="flex items-center px-3 py-2 rounded-md transition-colors duration-150 cursor-pointer"
                [ngClass]="item.styleClass"
                (click)="item.command?.($event)"
              >
                <i [class]="item.icon + ' mr-2'"></i>
                <span>{{ item.label }}</span>
              </a>
            </ng-template>
          </p-menu>


          <p-button
            (click)="toggleMenu($event, menu)"
            label="Amallar"
            [icon]="menuVisible ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"
            iconPos="right"
            severity="info"
            variant="outlined"
            class="rounded-md"
          ></p-button>
        </div>
      </div>
      <div class="justify-self-center text-center">
        <span class="text-2xl font-semibold">Guruh qo'shish</span>
      </div>
      <div class="justify-self-end"></div>
    </div>
  </ng-template>

  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <div class="p-5 space-y-12 max-w-3xl mx-auto">
    <!-- CATEGORY NAME -->
    <div>
      <p-floatlabel variant="in">
        <input class="w-full" formControlName="code" pInputText id="value2" autocomplete="off" />
        <label for="value2">Guruh nomi</label>
      </p-floatlabel>
    </div>
    <!-- IMAGE UPLOAD -->
    <div class="flex items-center gap-2 justify-center border border-dashed rounded-xl p-6 text-center hover:bg-gray-50 transition">
      <i class="pi pi-image"></i>
      <p class="text-sm">
        Rasmni bu yerga olib keling, <a class="text-blue-600 cursor-pointer hover:underline">fayllarni oching</a> yoki
        <a class="text-blue-600 cursor-pointer hover:underline">mavjud rasmlar to'plamidan tanlang</a>.
      </p>
    </div>
    <!-- PARENT CATEGORY -->
    <div>
      <div class="flex items-center justify-between">
        <div>
          <div class="flex justify-start gap-2">
            <i class="pi pi-sitemap" style="font-size: 1.5rem"></i>
            <label class="block font-bold">Guruhlar ichida guruh</label>
          </div>
          <p class="text-gray-500 text-sm">Buni kichik guruhga aylantirish uchun ota guruhini tanlang.</p>
          <p class="text-red-700 text-sm">Ushbu funksiya hoizrda mavjud emas!</p>
        </div>
        <p-button label="Tanlash" [disabled]="true" variant="text" severity="info" />
      </div>
    </div>
    <p-divider class="!border-t-8 !border-gray-300 my-4"></p-divider>
    <!-- ITEMS -->
    <div>
      <div class="flex items-center justify-between">
        <div>
          <label class="block text-xl font-bold">Tovarlar</label>
            @if (selectedItemModel.length === 0) {
              <p class="text-gray-500 text-sm">Qo'shilmagan</p>
            } @else {
              <div
                [pTooltip]="tooltipTemplate"
                tooltipPosition="top"
                tooltipStyleClass="bg-black/80 text-white rounded-lg p-3 shadow-lg max-w-xs"
                class="truncate whitespace-normal leading-snug max-h-[3rem] overflow-hidden cursor-help"
              >
                {{ getVisibleNames() }}
                @if(getHiddenCount() > 0){
                  <span class="text-gray-400">
                    va yana {{ getHiddenCount() }} ta
                  </span>
                }
              </div>

              <ng-template #tooltipTemplate>
                <div class="flex flex-col gap-1 text-sm font-medium">
                  @for(item of selectedItemModel; track item.id){
                    <div class="flex items-start gap-2">
                      <i class="pi pi-circle-fill text-xs mt-1 text-primary-400"></i>
                      <span>{{ item.name }}</span>
                    </div>
                  }
                </div>
              </ng-template>
            }
        </div>
        <p-button label="Qo'shish" variant="text" severity="info" (onClick)="openSelectItem()"/>
      </div>
    </div>
    <p-divider class="!border-t-8 !border-gray-300 my-4"></p-divider>
    <!-- SALES CHANNELS -->
    <div>
      <label class="block text-xl font-bold mb-2">Savdo kanallari va ish vaqti</label>
      <div class="flex items-center justify-between border rounded-lg px-4 py-3">
        <div class="flex items-center gap-3">
          <i class="pi pi-shopping-bag text-xl text-gray-600"></i>
          <div>
            <p class="font-medium text-gray-700">Savdo nuqtalari</p>
            <p class="text-sm text-gray-500">
              Turkumlar faqat Standart va Chakana savdo rejimida paydo bo'ladi.
            </p>
            <p class="text-red-700 text-sm">Ushbu funksiya hoizrda mavjud emas!</p>
          </div>
        </div>
        <p-toggle-switch [disabled]="true"></p-toggle-switch>
      </div>
    </div>
  </div>
  </form>

</p-dialog>

<p-dialog
  [(visible)]="showModalSelectItem"
  [closable]="false"
  [modal]="true"
  appendTo="body"
  [style]="{ width: '40rem' }"
  contentStyleClass="!p-6"
  maskStyleClass="!bg-black/70 !opacity-100 backdrop-blur-sm transition-all duration-300"
  styleClass="!top-8 !translate-y-0 fixed left-1/2 -translate-x-1/2 z-[10000]"
>
  <ng-template #header>
    <div class="w-full flex justify-between gap-2">
      <p-button type="button" label="Qo'shish" severity="primary" (onClick)="showModalSelectItem = false"></p-button>
      <p-button type="button" icon="pi pi-times" [variant]="'outlined'" [rounded]="true" (click)="showModalSelectItem = false" (onClick)="selectedItemModel = []"  pRipple></p-button>
    </div>
  </ng-template>
  <span class="font-bold text-2xl m-2">Guruhda tovarlarni qo'shish yoki ayirish</span>
  <p-table
    [value]="itemModel"
    [scrollable]="true"
    scrollHeight="flex"
    [tableStyle]="{ 'min-width': '30rem' }"

    #dt2
    dataKey="id"
    [rows]="10"
    [rowsPerPageOptions]="[10, 25, 50]"
    [loading]="loadingSelectItem"
    [paginator]="true"
    [globalFilterFields]="['name']"

    [(selection)]="selectedItemModel"
  >
    <ng-template #caption>
      <div class="flex items-center justify-between w-full">
        <!-- ðŸ” Qidiruv -->
        <p-iconfield iconPosition="left" class="flex-1">
          <p-inputicon><i class="pi pi-search"></i></p-inputicon>
          <input
            pInputText
            class="w-1/2"
            type="search"
            [(ngModel)]="searchValueItem"
            (input)="loadDataTableItem()"
            placeholder="Search keyword"
          />
        </p-iconfield>

        <!-- âŒ Deselect All tugmasi -->
        <p-button
          label="Tozalash"
          icon="pi pi-times"
          severity="secondary"
          size="small"
          class="ml-3"
          (onClick)="selectedItemModel = []"
          [disabled]="!selectedItemModel?.length"
        />
      </div>
    </ng-template>

    <ng-template #header>
      <tr>
        <th>Nomi</th>
        <th style="width: 4rem">{{ selectedItemModel.length }} ta</th>
      </tr>
    </ng-template>
    <ng-template #body let-item>
      <tr>
        <td>{{ item.name }}</td>
        <td>
          <p-tableCheckbox [value]="item" />
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-dialog>

