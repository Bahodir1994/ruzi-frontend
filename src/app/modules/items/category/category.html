<p-card class="card" xmlns="http://www.w3.org/1999/html">
  <ng-template #header>
    <p class="text-3xl font-bold px-4 pt-2">Guruhlar</p>
    @if(categoryModel.length > 0){
      <div class="flex w-full justify-between gap-2 p-4">
        <p-icon-field iconPosition="right" class="pr-2">
          <p-inputicon class="pi pi-search"></p-inputicon>
          <input
            type="text"
            pInputText
            placeholder="Qidiruv"
            [(ngModel)]="searchValue"
            (input)="loadDataTable()"
          />
        </p-icon-field>
        <p-button
          *kaHasRoles="['ROLE_CAT_CREATE']"
          class="pr-2"
          styleClass="shadow shadow-blue-500/50"
          icon="pi pi-file-plus"
          label="Yangi kategoriya qo'shish"
          (onClick)="dialog.maximize()"
          (click)="showModalCategory = true"
        />
      </div>
    }
  </ng-template>
  @if(categoryModel.length === 0){
      <div
        class="relative flex flex-col items-center justify-center border rounded px-20 py-28 text-center transition-all duration-200 mt-0"
      >
        <i class="pi pi-folder mb-3 text-gray-500" style="font-size: 4rem;"></i>
        <p class="text-2xl font-bold">
          Tovarlar guruhi
        </p>
        <span class="text-sm max-w-2xl">Guruhlar mahsulotlaringizni tartibga solishga, mijozlar Ushbu platformada qanday harakat qilishini aniqlashga, mahsulot sotuvi haqida hisobot berishga va elementlarni muayyan printerlarga yoâ€˜naltirishga yordam beradi.</span>
        <p-button
          *kaHasRoles="['ROLE_CAT_CREATE']"
          class="p-2"
          styleClass="shadow shadow-blue-500/50"
          icon="pi pi-file-plus"
          label="Yangi guruh qo'shish"
          (onClick)="dialog.maximize()"
          (click)="showModalCategory = true"
        />
      </div>
  } @else {
    <p-table
    size="small"
    #dataTableCategory
    [value]="categoryModel"
    dataKey="id"
    [rowHover]="true"
    [rows]="10"
    [showCurrentPageReport]="true"
    [rowsPerPageOptions]="[10, 25, 50]"
    loadingIcon="pi pi-spinner"
    [paginator]="true"
    currentPageReportTemplate="{totalPages} ta dan {currentPage}-saxifa, jami {totalRecords} ta dan {first}-{last} gacha"
    [filterDelay]="0"
    [globalFilterFields]="['orderNumber','supplier.name','warehouse.name']"
    (onFilter)="onFilter($event)"
    (onSort)="onSort($event)"
    [scrollable]="true"
    [totalRecords]="totalRecords"
    [lazy]="true"
    (onLazyLoad)="pageChange($event)"
    [first]="0"
    [pageLinks]="5"
    [showJumpToPageInput]="true"
    scrollHeight="650px"
    class=""
  >
    <ng-template pTemplate="body" let-item let-i="rowIndex">
      <tr>
        <td>
          <div class="grid grid-cols-12 gap-4 p-2 grid-nogutter">
            <div class="col-span-12">
              <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                <div class="md:w-20 h-20 w-20 relative">
                  <img
                    ngSrc="{{ imagePathPrefix + item.primaryImageUrl }}"
                    fill
                    decoding="async"
                    class="object-cover rounded-md bg-[url('/assets/images/no-image.png')]"
                  />
                </div>
                <div class="flex flex-col md:flex-row justify-between md:items-center flex-1 gap-6">
                  <div class="flex flex-row md:flex-col justify-between items-start gap-2">
                    <div>
                      <span class="font-medium text-secondary text-sm">{{ item.code }}</span>
                      <div class="text-lg font-medium text-surface-900 dark:text-surface-0 mt-2">{{ item.code }}</div>
                    </div>
                  </div>
                  <div class="flex flex-col md:items-end gap-8">
                    <div class="flex flex-row-reverse md:flex-row gap-2">
                      <span class="text-xl font-semibold text-surface-900 dark:text-surface-0">{{ item.items.length }}
                        ta tovar</span>
                      <p-button
                        size="small"
                        icon="pi pi-shopping-cart"
                        class="flex-auto md:flex-initial whitespace-nowrap"
                        label="qo'shish"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="6" class="text-center">Kategoriya topilmadi</td>
      </tr>
    </ng-template>
  </p-table>
  }
</p-card>

<p-dialog
  [(visible)]="showModalCategory"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [closable]="true"
  [maximizable]="true"
  [dismissableMask]="true"
  [style]="{ minWidth: '50rem'}"
  #dialog
  [baseZIndex]="10000">
  <ng-template #header>
    <div class="grid grid-cols-[auto,1fr,auto] items-center gap-3 w-full">
      <div class="flex items-center gap-2">
        <form [formGroup]="form" (ngSubmit)="onSubmit()" class="contents">
        <p-button type="submit" label="Saqlash" severity="primary"></p-button>
      </form>
        <div class="justify-self-end flex items-center gap-2 ml-2">
          <p-menu #menu [model]="actions" [popup]="true" appendTo="body" styleClass="rounded-lg shadow-md">
            <ng-template pTemplate="item" let-item>
              <a
                pRipple
                class="flex items-center px-3 py-2 rounded-md transition-colors duration-150 cursor-pointer"
                [ngClass]="item.styleClass"
                (click)="item.command?.($event)"
              >
                <i [class]="item.icon + ' mr-2'"></i>
                <span>{{ item.label }}</span>
              </a>
            </ng-template>
          </p-menu>


          <p-button
            (click)="toggleMenu($event, menu)"
            label="Amallar"
            [icon]="menuVisible ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"
            iconPos="right"
            severity="info"
            variant="outlined"
            class="rounded-md"
          ></p-button>
        </div>
      </div>
      <div class="justify-self-center text-center">
        <span class="text-2xl font-semibold">Guruh qo'shish</span>
      </div>
      <div class="justify-self-end"></div>
    </div>
  </ng-template>

  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <div class="p-5 space-y-12 max-w-3xl mx-auto">
    <!-- CATEGORY NAME -->
    <div>
      <p-floatlabel variant="in">
        <input class="w-full" formControlName="code" pInputText id="value2" autocomplete="off" />
        <label for="value2">Guruh nomi</label>
      </p-floatlabel>
    </div>
    <!-- IMAGE UPLOAD -->
    <div class="w-full mx-auto items-center gap-2 justify-center border border-dashed rounded-xl p-6 text-center hover:bg-gray-50 transition">
      <div class="w-full mx-auto flex gap-2">
        <i class="pi pi-image"></i>
        <p class="text-sm">
          Rasmni bu yerga olib keling, <a class="text-blue-600 cursor-pointer hover:underline">fayllarni oching</a> yoki
          <a (click)="openSelectImage()" class="text-blue-600 cursor-pointer hover:underline">mavjud rasmlar to'plamidan tanlang</a>.
        </p>
      </div>
      @if((selectedImages.length > 0) && !showModalSelectImage){
        <div
          class="mt-2 mx-auto relative w-28 h-28 rounded-lg overflow-hidden border group shadow-sm hover:shadow-md transition-all duration-200 bg-gray-50"
        >
          <img
            ngSrc="{{ imagePathPrefix + selectedImages[0].parentId + '/' + selectedImages[0].docName }}"
            fill
            alt="{{ selectedImages[0].docName }}"
            decoding="async"
            class="p-2 object-cover w-full h-full transition-transform duration-200 group-hover:scale-105"
          />

          <div
            class="absolute inset-0 flex items-center justify-center gap-3 opacity-0 group-hover:opacity-100 transition-all duration-200 bg-black/40">
            <button
              type="button"
              class="border border-red-500 text-red-500 rounded-full w-10 h-10 flex items-center justify-center
                 hover:bg-red-500 hover:text-white transition-colors duration-150"
              (click)="$event.stopPropagation(); selectedImages = []"
              pTooltip="Oâ€˜chirish"
              tooltipPosition="top"
            >
              <i class="pi pi-trash text-lg"></i>
            </button>
          </div>

        </div>
        <div
          class="text-md text-center py-1 truncate group-hover:bg-white/0"
          title="{{ selectedImages[0].docName }}"
        >
          {{ selectedImages[0].docName }}
        </div>
      }
    </div>
    <!-- PARENT CATEGORY -->
    <div>
      <div class="flex items-center justify-between">
        <div>
          <div class="flex justify-start gap-2">
            <i class="pi pi-sitemap" style="font-size: 1.5rem"></i>
            <label class="block font-bold">Guruhlar ichida guruh</label>
          </div>
          <p class="text-gray-500 text-sm">Buni kichik guruhga aylantirish uchun ota guruhini tanlang.</p>
          <p class="text-red-700 text-sm">Ushbu funksiya hoizrda mavjud emas!</p>
        </div>
        <p-button label="Tanlash" [disabled]="true" variant="text" severity="info" />
      </div>
    </div>
    <p-divider class="!border-t-8 !border-gray-300 my-4"></p-divider>
    <!-- ITEMS -->
    <div>
      <div class="flex items-center justify-between">
        <div>
          <label class="block text-xl font-bold">Tovarlar</label>
            @if (selectedItemModel.length === 0) {
              <p class="text-gray-500 text-sm">Qo'shilmagan</p>
            } @else {
              <div
                [pTooltip]="tooltipTemplate"
                tooltipPosition="top"
                tooltipStyleClass="bg-black/80 text-white rounded-lg p-3 shadow-lg max-w-xs"
                class="truncate whitespace-normal leading-snug max-h-[3rem] overflow-hidden cursor-help"
              >
                {{ getVisibleNames() }}
                @if(getHiddenCount() > 0){
                  <span class="text-gray-400">
                    va yana {{ getHiddenCount() }} ta
                  </span>
                }
              </div>

              <ng-template #tooltipTemplate>
                <div class="flex flex-col gap-1 text-sm font-medium">
                  @for(item of selectedItemModel; track item.id){
                    <div class="flex items-start gap-2">
                      <i class="pi pi-circle-fill text-xs mt-1 text-primary-400"></i>
                      <span>{{ item.name }}</span>
                    </div>
                  }
                </div>
              </ng-template>
            }
        </div>
        <p-button label="Qo'shish" variant="text" severity="info" (onClick)="openSelectItem()"/>
      </div>
    </div>
    <p-divider class="!border-t-8 !border-gray-300 my-4"></p-divider>
    <!-- SALES CHANNELS -->
    <div>
      <label class="block text-xl font-bold mb-2">Savdo kanallari va ish vaqti</label>
      <div class="flex items-center justify-between border rounded-lg px-4 py-3">
        <div class="flex items-center gap-3">
          <i class="pi pi-shopping-bag text-xl text-gray-600"></i>
          <div>
            <p class="font-medium text-gray-700">Savdo nuqtalari</p>
            <p class="text-sm text-gray-500">
              Turkumlar faqat Standart va Chakana savdo rejimida paydo bo'ladi.
            </p>
            <p class="text-red-700 text-sm">Ushbu funksiya hoizrda mavjud emas!</p>
          </div>
        </div>
        <p-toggle-switch [disabled]="true"></p-toggle-switch>
      </div>
    </div>
  </div>
  </form>

</p-dialog>

<p-dialog
  [(visible)]="showModalSelectItem"
  [closable]="false"
  [modal]="true"
  [style]="{ width: '40rem' }"
  [baseZIndex]="1000"
>
  <ng-template #header>
    <div class="w-full flex justify-between gap-2">
      <p-button type="button" label="Qo'shish" severity="primary" (onClick)="showModalSelectItem = false" [disabled]="!(selectedItemModel.length > 0)"></p-button>
      <p-button type="button" icon="pi pi-times" [variant]="'outlined'" [rounded]="true" (click)="showModalSelectItem = false" (onClick)="selectedItemModel = []"  pRipple></p-button>
    </div>
  </ng-template>
  <span class="font-bold text-2xl m-2">Guruhda tovarlarni qo'shish yoki ayirish</span>
  <p-table
    [value]="itemModel"
    [scrollable]="true"
    scrollHeight="flex"
    [tableStyle]="{ 'min-width': '30rem' }"

    #dt2
    dataKey="id"
    [rows]="10"
    [rowsPerPageOptions]="[10, 25, 50]"
    [loading]="loadingSelectItem"
    [paginator]="true"
    [globalFilterFields]="['name']"

    [(selection)]="selectedItemModel"
  >
    <ng-template #caption>
      <div class="flex items-center justify-between w-full">
        <!-- ðŸ” Qidiruv -->
        <p-iconfield iconPosition="left" class="flex-1">
          <p-inputicon><i class="pi pi-search"></i></p-inputicon>
          <input
            pInputText
            class="w-1/2"
            type="search"
            [(ngModel)]="searchValueItem"
            (input)="loadDataTableItem()"
            placeholder="Search keyword"
          />
        </p-iconfield>

        <!-- âŒ Deselect All tugmasi -->
        <p-button
          label="Tozalash"
          icon="pi pi-times"
          severity="secondary"
          size="small"
          class="ml-3"
          (onClick)="selectedItemModel = []"
          [disabled]="!(selectedItemModel.length > 0)"
        />
      </div>
    </ng-template>

    <ng-template #header>
      <tr>
        <th>Nomi</th>
        <th style="width: 4rem">{{ selectedItemModel.length }} ta</th>
      </tr>
    </ng-template>
    <ng-template #body let-item>
      <tr>
        <td>{{ item.name }}</td>
        <td>
          <p-tableCheckbox [value]="item" />
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-dialog>

<p-dialog
  [(visible)]="showModalSelectImage"
  [modal]="true"
  [closable]="false"
  [style]="{ width: '40rem', minHeight: '40rem'}"
  [baseZIndex]="1100"
>
  <ng-template #header>
    <div class="w-full flex justify-between">
      <span class="text-2xl font-bold">Rasmlar to'plami</span>
      <p-button type="button" icon="pi pi-times" [variant]="'outlined'" [rounded]="true" (click)="showModalSelectImage = false" (onClick)="selectedImages = []"  pRipple></p-button>
    </div>
  </ng-template>
  <div class="flex items-center justify-between w-full mt-0 pt-0">
    @if (imagesList.length > 0) {
      <div class="flex items-center gap-2">
        <span class="p-input-icon-left">
          <input
            type="search"
            pInputText
            [(ngModel)]="searchQuery"
            placeholder="Qidiruv..."
            (input)="applyFilters()"
          />
        </span>
        <p-select
          [options]="sortOptions"
          [(ngModel)]="selectedSort"
          placeholder="Saralash..."
          optionLabel="label"
          class="w-40"
          (onChange)="applyFilters()"
        ></p-select>
      </div>
    }
  </div>
  @if (isLoadingImage) {
    <div
      class="absolute inset-0 flex flex-col items-center justify-center"
    >
      <p-progressSpinner></p-progressSpinner>
    </div>
  } @else if (imagesList.length == 0) {
    <div
      class="flex items-center justify-center w-full h-[calc(100%-3rem)]"
    >
      <div class="flex flex-col items-center justify-center gap-3 text-center">
        <i class="pi pi-images" style="font-size: 3rem"></i>
        <span class="font-bold text-2xl text-gray-700">Rasmlar to'plami bo'sh</span>
        <a routerLink="/items/image" pButton target="_blank">
          <span pButtonLabel>Rasm qo'shish</span>
        </a>
      </div>
    </div>
  }@else {
    <p-scrollPanel [style]="{ width: '100%', height: '60vh' }">
      <div class="mt-6 flex flex-wrap gap-6">
        @for (img of filteredImages; track img.id) {
          <div
            class="relative w-28 h-28 rounded-lg overflow-hidden border group shadow-sm hover:shadow-md transition-all duration-200 bg-gray-50"
            (click)="toggleSelection(img)"
          >
            <div
              class="absolute top-0 left-0 z-10 bg-white/90 rounded-md p-1 shadow-sm cursor-pointer"
              (click)="$event.stopPropagation(); toggleSelection(img)"
            >
              <p-checkbox
                binary="true"
                [ngModel]="isSelected(img)"
                [style]="{ transform: 'scale(0.9)' }"
              ></p-checkbox>
            </div>

            <img
              ngSrc="{{ imagePathPrefix + img.parentId + '/' + img.docName }}"
              fill
              alt="{{ img.docName }}"
              decoding="async"
              class="p-2 object-cover w-full h-full transition-transform duration-200 group-hover:scale-105"
            />

            <div
              class="absolute bottom-0 left-0 w-full bg-black/70 text-white text-md text-center py-1 truncate group-hover:bg-white/0"
              title="{{ img.docName }}"
            >
              {{ img.docName }}
            </div>

            @if (isSelected(img)) {
              <div class="absolute inset-0 border-4 border-sky-500 rounded-lg pointer-events-none"></div>
            }
          </div>
        }
      </div>
    </p-scrollPanel>
    <ng-template #footer
    >
      <div class="w-full flex items-center justify-between border-t-2">
        <p-button label="Tanlash" class="pt-2" [disabled]="!(selectedImages.length > 0)" (onClick)="showModalSelectImage = false"/>
      </div>
    </ng-template>
  }
</p-dialog>

