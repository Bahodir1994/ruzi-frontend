<div class="flex h-screen w-screen">
  <p-splitter class="w-full" gutterSize="10" panelStyleClass="shadow-lg" [panelSizes]="[60, 40]" [minSizes]="[60, 40]" [style]="{border: '0!important'}">
    <ng-template #panel>
      <div class="flex flex-col h-full">
        <div class="p-1 shadow-sm flex-none bg-[var(--p-primary-color)]">
          <div class="flex justify-between">
            <div class="flex items-center w-[700px] gap-2">
              <p-button>
                <i class="pi pi-star rounded-lg" style="font-size: 2rem"></i>
              </p-button>
              <input
                #searchInput
                type="search"
                pInputText
                pSize="large"
                placeholder="Tovarlarni qidirish..."
                class="flex-1 px-4 focus:ring-0 focus:outline-none"
                [(ngModel)]="searchValue"
                (input)="loadData()"
              />
            </div>
            <div class="flex justify-around align-middle my-auto">
              <p-button>
                <i class="pi pi-list" style="font-size: 2rem"></i>
              </p-button>
              <p-button>
                <i class="pi pi-tags" style="font-size: 2rem"></i>
              </p-button>
              <div class="flex items-center border rounded gap-1">
                <!-- List tugma -->
                <p-button
                  pRipple
                  [ngClass]="{ '!text-[var(--p-primary-color)]': layout === 'list' }"
                  (click)="layout = 'list'"
                  pTooltip="Ro‘yxat ko‘rinishi"
                  tooltipPosition="bottom"
                >
                  <i class="pi pi-bars text-2xl"></i>
                </p-button>

                <!-- Grid tugma -->
                <p-button
                  pRipple
                  [ngClass]="{ '!text-[var(--p-primary-color)]': layout === 'grid' }"
                  (click)="layout = 'grid'"
                  pTooltip="Katalog ko‘rinishi"
                  tooltipPosition="bottom"
                >
                  <i class="pi pi-table text-2xl"></i>
                </p-button>
              </div>
            </div>
          </div>
        </div>
        <div class="flex-1 overflow-y-auto p-2">
          <p-dataView
            #dv [value]="stockView"
            [layout]="layout"
            [rows]="10"
            [rowsPerPageOptions]="[10, 25, 50]"
            [totalRecords]="totalRecords"
            [paginator]="true"
            [lazy]="true"
            (onLazyLoad)="pageChange($event)"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="{totalPages} saxifa, jami {totalRecords} ta ma`lumot"
          >
            <ng-template #list let-items>
              @for (item of items; track item.stockId; let first = $first) {
                <div
                    pRipple
                    class="flex items-center gap-4 p-4 border-b border-surface-200 dark:border-surface-700
                     hover:bg-[var(--p-surface-hover)] cursor-pointer transition-all"
                    (click)="onSelectItem(item)"
                  >
                    <!-- Chap: rasm -->
                    <div class="w-20 h-20 flex-shrink-0 relative">
                      <img
                        [src]="item.imageUrl || 'assets/no-image.png'"
                        class="rounded-md w-full h-full object-cover"
                        alt="Tovar rasmi"
                      />
<!--                      @if (item.categoryName){-->
<!--                        <p-tag-->
<!--                          [value]="item.categoryName"-->
<!--                          severity="success"-->
<!--                          class="absolute top-1 left-1 dark:!bg-surface-900"-->
<!--                        ></p-tag>-->
<!--                      }-->
                    </div>
                    <!-- O‘rta: nom, kodlar, birlik -->
                    <div class="flex flex-col flex-1 overflow-hidden">
                      <div class="flex items-center justify-between">
                        <span class="font-semibold text-lg truncate text-surface-900 dark:text-surface-0">
                          {{ item.itemName }}
                        </span>
                        <span class="text-xs px-2 py-0.5 bg-surface-100 dark:bg-surface-700 rounded font-mono text-gray-600 dark:text-gray-300">{{ item.itemCode }}</span>
                      </div>
                      <div class="flex items-center gap-2 text-sm text-gray-500 mt-1">
                        <i class="pi pi-barcode text-yellow-500"></i>
                        <span>{{ item.barcode || '–' }}</span>
                        <span class="text-gray-400">•</span>
                        <span>{{ item.unitName }}</span>
                        <span class="text-gray-400">•</span>
                        <span>{{ item.warehouseName }}</span>
                      </div>
                      <div class="mt-1 text-xs text-gray-400">
                        Partiya: {{ item.batchNumber || '—' }}
                        @if (item.expiryDate){
                          <span>• Yaroqlilik: {{ item.expiryDate | date:'dd.MM.yyyy' }}</span>
                        }
                      </div>
                    </div>
                    <!-- O‘ng: narx va qoldiq -->
                    <div class="flex flex-col items-end min-w-[140px]">
                      <div class="font-bold text-xl text-emerald-600">
                        {{ item.salePrice | number:'1.2-2' }} soʻm
                      </div>

                      <div class="flex items-center gap-1 text-sm mt-1">
                        <i class="pi pi-box text-sky-500"></i>
                        <span>Qoldiq:</span>
                        <span
                          class="font-semibold text-surface-900 dark:text-surface-0">{{ item.availableQuantity }}</span>
                      </div>

                      @if(item.reservedQuantity > 0){
                        <div class="text-xs text-orange-500">
                          (Rezerv: {{ item.reservedQuantity }})
                        </div>
                      }
                    </div>
                  </div>
              }
            </ng-template>
            <ng-template #grid let-items>
              <div class="grid grid-cols-12 gap-4">
                @for (product of items; track product.itemId) {
                  <div class="col-span-12 sm:col-span-6 md:col-span-4 xl:col-span-3 p-2">
                    <div
                      pRipple
                      class="flex flex-col rounded-xl border border-surface-200 dark:border-surface-700 bg-white dark:bg-surface-900 shadow-sm hover:shadow-md transition-all cursor-pointer h-full"
                      (click)="onSelectItem(product)">
                      <!-- Rasm va kategoriya tag -->
                      <div class="relative bg-surface-50 dark:bg-surface-800 flex justify-center items-center rounded-t-xl p-4">
                        <img
                          class="rounded-md object-contain max-h-[180px]"
                          [src]="product.imageUrl || 'assets/no-image.png'"
                          [alt]="product.itemName"
                        />
                        @if (product.categoryName){
                          <p-tag
                            [value]="product.categoryName"
                            severity="success"
                            class="absolute top-2 left-2 dark:!bg-surface-900"
                          ></p-tag>
                        }
                        <!-- Chegirma belgisi -->
                        @if(product.discount && product.discount > 0){
                          <p-tag
                            [value]="product.discount + '%'"
                            severity="danger"
                            class="absolute top-2 right-2"
                          ></p-tag>
                        }
                      </div>

                      <!-- Maʼlumotlar -->
                      <div class="flex flex-col justify-between flex-1 p-4 gap-2">
                        <!-- Nomi va kodi -->
                        <div class="flex flex-col gap-1">
                          <span class="font-semibold text-base text-surface-900 dark:text-surface-0 truncate">
                            {{ product.itemName }}
                          </span>
                          <div class="flex flex-wrap gap-2 items-center text-xs text-gray-500">
                            <i class="pi pi-barcode text-yellow-500"></i>
                            <span>{{ product.barcode || '–' }}</span>
                            <span class="text-gray-400">•</span>
                            <span>{{ product.itemCode }}</span>
                          </div>
                        </div>
                        <!-- Ombor va partiya -->
                        <div class="text-xs text-gray-500 flex flex-col">
                          <span>Ombor: {{ product.warehouseName }}</span>
                          @if(product.batchNumber){
                            <span>Partiya: {{ product.batchNumber }}</span>
                          }
                          @if(product.expiryDate){
                            <span>Yaroqlilik: {{ product.expiryDate | date:'dd.MM.yyyy' }}</span>
                          }
                        </div>

                        <!-- Narx, birlik va qoldiq -->
                        <div class="flex justify-between items-end mt-auto pt-2 border-t border-gray-200 dark:border-surface-700">
                          <div class="flex flex-col text-sm">
                            <span class="text-gray-400">Narx</span>
                            <span class="font-bold text-lg text-emerald-600">{{ product.salePrice | number:'1.2-2' }} soʻm</span>
                          </div>
                          <div class="flex flex-col text-right text-sm">
                            <div>
                              <span class="text-gray-400">Qoldiq:</span>
                              <span
                                [ngClass]="{
                                  'text-red-500 font-semibold': product.availableQuantity < 3,
                                  'text-surface-900 dark:text-surface-0 font-semibold': product.availableQuantity >= 3
                                }"
                              >{{ product.availableQuantity ?? (product.quantity - product.reservedQuantity) }}</span>
                            </div>
                            <span class="text-gray-500 text-xs">({{ product.unitName }})</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                }
              </div>
            </ng-template>
            <ng-template #emptymessage>
              <div class="flex flex-col items-center justify-center py-10 text-center text-gray-500">
                <i class="pi pi-box text-6xl text-gray-400 mb-4"></i>
                <h3 class="text-2xl font-semibold mb-2 text-gray-600">Tovar topilmadi</h3>
                <p class="text-gray-400 text-base">
                  Qidiruv natijasiga mos tovar mavjud emas. Boshqa kalit so‘zni kiriting.
                </p>
                <p-button
                  label="Qayta urinish"
                  icon="pi pi-refresh"
                  class="mt-4 p-button-outlined p-button-sm"
                  (onClick)="searchValue=''; loadData()"
                ></p-button>
              </div>
            </ng-template>
          </p-dataView>
        </div>
      </div>
    </ng-template>
    <ng-template #panel>
      <div class="flex flex-wrap justify-between items-center gap-4 px-4 py-1 shadow-sm bg-[var(--p-primary-color)]">
          <p-button pTooltip="Mijozlar ro'yxati" (onClick)="onPopoverHide()" (click)="opReferrers?.hide(); opCustomers.toggle($event)" tooltipPosition="bottom">
            <i class="pi pi-address-book" style="font-size: 2rem"></i>
          </p-button>
          <p-button pTooltip="Xamkorlar" tooltipPosition="bottom" (onClick)="onPopoverHide()" (click)="opCustomers?.hide(); opReferrers.toggle($event)">
            <i class="pi pi-user" style="font-size: 2rem"></i>
          </p-button>
          <p-menu #menu [model]="menuItems" [popup]="true"></p-menu>
          <p-button (click)="menu.toggle($event)">
            <i class="pi pi-cog" style="font-size: 2rem"></i>
          </p-button>
          <div class="flex flex-col items-end lg:items-end text-center lg:flex-1">
            <!-- To‘liq ma'lumot (katta ekranlarda ko‘rinadi) -->
            <div class="hidden lg:flex flex-col items-center justify-center gap-1">
              <div class="flex flex-wrap items-center justify-center gap-2">
              <span class="text-xl sm:text-xl font-bold text-[var(--p-primary-contrast-color)]">
                № {{ cartSessionModel?.cartNumber }}
              </span>
              <span
                class="px-2 text-xs rounded-full bg-emerald-100 text-emerald-700 uppercase tracking-wide">
                {{ cartSessionModel?.status }}
              </span>
              </div>
              <div
                class="flex flex-wrap items-center justify-center text-xs sm:text-sm gap-1 text-[var(--p-primary-contrast-color)]">
                <span>Sotuvchi:</span>
                <span class="font-medium">{{ cartSessionModel?.createdByUser }}</span>
                <span class="hidden sm:inline select-none">•</span>
                <time class="truncate">{{ cartSessionModel?.createdAt | date:'yy-MM-dd HH:mm' }}</time>
              </div>
            </div>
            <!-- “i” info tugma (≤1024 px bo‘lganda ko‘rinadi) -->
            <div class="flex lg:hidden items-center justify-center">
              <p-button
                size="small"
                pTooltip="№ {{ cartSessionModel?.cartNumber }} | {{ cartSessionModel?.status }} | {{ cartSessionModel?.createdByUser }} | {{ cartSessionModel?.createdAt | date:'yy-MM-dd HH:mm' }}"
                tooltipPosition="bottom"
                tooltipStyleClass="text-center max-w-[260px]"
              >
                <i class="pi pi-info-circle" style="font-size: 2rem"></i>
              </p-button>
            </div>
          </div>
      </div>
      <div class="card flex flex-col h-full w-full p-2">
        <div class="flex justify-start p-2 border-bottom">
          @if (cartSessionModel && cartSessionModel.customer != null){
            <p-chip
              label="Mijoz: {{ cartSessionModel.customer.fullName }}"
              image="https://primefaces.org/cdn/primeng/images/demo/avatar/xuxuefeng.png"
              alt="Avatar image"
              [removable]="true"
              (onRemove)="removeCusRefFromCart(cartSessionModel.customer.id, 'CUSTOMER')"
            />
          }
          @if (cartSessionModel && cartSessionModel.referrer != null){
            <p-chip
              label="Xamkor: {{ cartSessionModel.referrer.fullName }}"
              image="https://primefaces.org/cdn/primeng/images/demo/avatar/xuxuefeng.png" alt="Avatar image"
              [removable]="true"
              (onRemove)="removeCusRefFromCart(cartSessionModel.referrer.id, 'REFERRER')"
            />
          }
        </div>
        <p-list-box
          [options]="cartItems!"
          [dragdrop]="true"
          scrollHeight="calc(100vh - 160px)"
          class="w-full !border-0 !shadow-none !outline-none !ring-0"
        >
          <ng-template let-item #item>
            <div class="flex flex-wrap justify-between w-full items-center">
              <!-- Chap: nom va birlik narxi -->
              <div class="flex flex-col flex-1 min-w-[150px] sm:min-w-[180px]">
                <span class="font-semibold truncate">{{ item.itemName }}</span>
                <span class="text-xs sm:text-sm text-gray-500">
                  {{ item.unitPrice | number: '1.2-2' }} soʻm / dona
                </span>
              </div>

              <!-- O‘ng: miqdor, narx, o‘chirish -->
              <div class="flex items-center gap-2 sm:gap-3 mt-2 sm:mt-0 flex-wrap justify-end w-full sm:w-auto">
                <!-- Miqdor boshqaruvi -->
                <div class="flex items-center gap-1 sm:gap-2">
                  <p-button
                    size="small"
                    icon="pi pi-minus"
                    [rounded]="true"
                    [outlined]="true"
                    [disabled]="item.quantity <= 1"
                    (mousedown)="startHold(decrease.bind(this, item))"
                    (mouseup)="stopHold()"
                    (mouseleave)="stopHold()"
                    (touchstart)="startHold(decrease.bind(this, item))"
                    (touchend)="stopHold()"
                  ></p-button>
                  <span class="font-semibold w-8 sm:w-10 text-center select-none text-xs sm:text-sm">
                    {{ item.quantity }}
                  </span>
                  <p-button
                    icon="pi pi-plus"
                    size="small"
                    [rounded]="true"
                    (mousedown)="startHold(increase.bind(this, item))"
                    (mouseup)="stopHold()"
                    (mouseleave)="stopHold()"
                    (touchstart)="startHold(increase.bind(this, item))"
                    (touchend)="stopHold()"
                  ></p-button>
                </div>

                <!-- Umumiy narx -->
                <div class="text-right font-bold text-emerald-600 text-sm sm:text-md min-w-[80px] sm:min-w-[100px]">
                  {{ item.lineTotal | number: '1.2-2' }}
                </div>

                <!-- O‘chirish tugmasi -->
                <p-button
                  class="hidden sm:inline-flex"
                  [rounded]="true"
                  [outlined]="true"
                  severity="danger"
                  icon="pi pi-times"
                  size="small"
                  (click)="removeItem(item.cartItemId)"
                ></p-button>

                <!-- Mobilda ⋮ tugmasi -->
                <p-button
                  class="sm:hidden"
                  [rounded]="true"
                  [outlined]="true"
                  icon="pi pi-ellipsis-v"
                  size="small"
                  (click)="removeItem(item.cartItemId)"
                ></p-button>
              </div>
            </div>

          </ng-template>
        </p-list-box>
      </div>
      <footer class="sticky bottom-0 w-full border-t shadow-inner px-2 flex flex-wrap justify-between items-center gap-3 "
      >
        <div>
          <div class="text-sm">Jami summa:</div>
          <div class="text-2xl font-bold text-emerald-600">
            {{ subtotal() | number:'1.2-2' }} so‘m
          </div>
        </div>
        <p-button
          size="large"
          label="To‘lash"
          icon="pi pi-credit-card"
          class="!text-lg !px-6 !py-3"
          (click)="checkout()"
        ></p-button>
      </footer>
    </ng-template>
  </p-splitter>
</div>

<div class="absolute bottom-4 rounded-3xl left-4 bg-white dark:bg-gray-700">
  <p-button
    [rounded]="true"
    [text]="true"
    [raised]="true"
    [outlined]="false"
    routerLink="/"
  >
    <i class="pi pi-shop p-5" style="font-size: 2.5rem"></i>
  </p-button>
  <div class="absolute bottom-4 shadow-xl rounded-3xl left-32 p-4 bg-white dark:bg-gray-700">
    <theme-switcher [toTop]="true"/>
  </div>
</div>

<p-popover #opCustomers (onShow)="onPopoverShow()" (onHide)="onPopoverHide()">
  <ng-template #content>
    <p-listbox
      [options]="customers!"
      optionValue="id"
      filterBy="fullName,clientCode"
      [filter]="true"
      filterPlaceHolder="Mijoz qidirish..."
      class="w-full min-w-72"
      [checkmark]="true"
      [highlightOnSelect]="false"
      (onChange)="addCustomerToCard($event.value, opCustomers)"
    >
      <ng-template #item let-customer>
        <div class="flex items-center w-full gap-2">
          <i class="pi pi-user"></i>
          <div>
            <span class="font-medium">{{ customer.fullName }}</span>
            <div class="text-sm text-muted-color">{{ customer.phoneNumber }}</div>
          </div>
          <div class="flex items-end gap-2 text-muted-color ml-auto text-sm">
            <span>{{ customer.clientCode }}</span>
          </div>
        </div>
      </ng-template>
    </p-listbox>

  </ng-template>
</p-popover>

<p-popover #opReferrers (onShow)="onPopoverShow()" (onHide)="onPopoverHide()" >
  <ng-template #content>
    <p-listbox
      [options]="referrers!"
      optionValue="id"
      filterBy="fullName,referrerCode"
      [filter]="true"
      filterPlaceHolder="Xamkor qidirish..."
      class="w-full min-w-72"
      [checkmark]="true"
      [highlightOnSelect]="false"
      (onChange)="addReferrerToCard($event.value, opReferrers)"
    >
      <ng-template #item let-referrer>
        <div class="flex items-center w-full gap-2">
          <i class="pi pi-user"></i>
          <div>
            <span class="font-medium">{{ referrer.fullName }}</span>
            <div class="text-sm text-muted-color">{{ referrer.phoneNumber }}</div>
          </div>
          <div class="flex items-end gap-2 text-muted-color ml-auto text-sm">
            <span>{{ referrer.referrerCode }}</span>
          </div>
        </div>
      </ng-template>
    </p-listbox>
  </ng-template>
</p-popover>

<app-payments-dialog
  [visible]="payVisible"
  [cartSessionId]="cartSessionModel!.id"
  [total]="subtotal()"
  [hasCustomer]="hasCustomer"
  [hasReferrer]="!!cartSessionModel?.referrer"
  [defaultRefPercent]="refPercentDefault"
  (closed)="onPayClosed($event)">
</app-payments-dialog>
