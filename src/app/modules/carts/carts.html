<p-card class="card">
  <ng-template #header>
    <p class="text-3xl font-bold px-4 pt-2">Savatlar to'plami</p>
  </ng-template>
  @if (cartSessionModel.length === 0 && !searchValue && allRecords == 0) {
    <div
      class="relative flex flex-col items-center justify-center border rounded px-20 py-24 text-center transition-all duration-200 mt-0"
    >
      <img ngSrc="assets/images/icons/black-friday.png" width="200" height="200" alt="icon"/>

      <p class="text-2xl font-bold">
        Savatlar to'plami
      </p>

      <span class="text-sm max-w-3xl">
        Xaridorlar uchun yaratilgan savatlar ro'yxati. Ushbu bo'limda savatlar ro'yxatini boshqarish ularni xolatini ozgartrish, qarzodroliklarni yopish mumkin.
      </span>

    </div>
  } @else {
    <div class="grid grid-cols-5">
      <div class="col-span-2 grid grid-rows-2 md:grid-rows-2 border-r border-b gap-2 p-2">
        <div class="px-2">
          <p-icon-field iconPosition="right" >
            <p-inputicon class="pi pi-search"></p-inputicon>
            <input
              type="search"
              pInputText
              placeholder="Qidiruv"
              [(ngModel)]="searchValue"
              (input)="loadData()"
              fluid
            />
          </p-icon-field>
        </div>
        <div class="px-2 grid grid-cols-3 md:grid-cols-3 items-center justify-content-between gap-2">
          <p-floatlabel class="w-full " variant="on">
            <input
              id="createdDate"
              pInputText
              type="date"
              class="w-full"
              [ngModel]="defDate"
              (ngModelChange)="onDateChange($event)"
              placeholder="dd.mm.yyyy"
            />
            <label for="createdDate">Yaratilgan vaqti</label>
          </p-floatlabel>
          <p-floatlabel variant="on"  class="w-full">
            <p-select
              id="selectPaymentType"
              [options]="selectPaymentType"
              optionValue="value"
              optionLabel="label"
              [(ngModel)]="selectedPaymentType"
              [showClear]="true"
              (ngModelChange)="onPayTypeAndPayStatusChange()"
              fluid
            ></p-select>
            <label for="selectPaymentType">To'lov turi</label>
          </p-floatlabel>
          <p-floatlabel variant="on" class="w-full">
            <p-select
              id="selectPaymentStatus"
              [options]="selectPaymentStatus"
              optionValue="value"
              optionLabel="label"
              [(ngModel)]="selectedPaymentStatus"
              [showClear]="true"
              (ngModelChange)="onPayTypeAndPayStatusChange()"
              fluid
            ></p-select>
            <label for="selectPaymentStatus">To'lov holati</label>
          </p-floatlabel>

        </div>
      </div>
      <div class="col-span-3 grid grid-cols-2 md:grid-cols-2 gap-0 border-b">
        <div class="grid grid-rows-2 border-r">
          <div class="border-b p-2">
            <p class="text-sm text-gray-500">To'langan summa</p>
            <p class="text-2xl font-bold text-green-700">
              {{ paidAmountPeriod | number:'1.2-2' }}
            </p>
          </div>
          <div class="p-2">
            <p class="text-sm text-gray-500">Qarzlar</p>
            <p class="text-2xl font-extrabold text-red-600">
              {{ debtAmountPeriod | number:'1.2-2' }}
            </p>
          </div>
        </div>
        <div class="grid grid-rows-2">
          <div class="border-b p-2">
            <p class="text-sm text-gray-500">Jami hisoblangan summa (tanlangan davr bo‘yicha)</p>
            <p class="text-2xl font-bold text-blue-700">
              {{ totalAmountPeriod | number:'1.2-2' }}
            </p>
          </div>
          <div class="card flex justify-center p-2">
            <p-selectButton size="small" [options]="stateOptions" (onChange)="setPeriod()" [(ngModel)]="selectedPeriod" optionLabel="label" optionValue="value" aria-labelledby="basic" />
          </div>
        </div>
      </div>
    </div>
    <p-table
      size="small"
      #dataTableCart
      [value]="cartSessionModel"
      [rows]="10"
      [rowHover]="true"
      [paginator]="true"
      [rowsPerPageOptions]="[10,25,50]"
      [lazy]="true"
      [totalRecords]="totalRecords"
      (onLazyLoad)="pageChange($event)"
      dataKey="id"
      scrollHeight="80vh"
      [scrollable]="true"
    >
      <ng-template pTemplate="header">
        <tr class="border shadow h-[60px]">

          <th class="text-nowrap sort-header">№</th>

          <th class="text-center text-nowrap sort-header">Savat raqami</th>

          <th class="text-center text-nowrap sort-header">Holati</th>

          <th class="text-center text-nowrap sort-header">To'lov turi</th>

          <th class="text-center text-nowrap sort-header">To'lov holati</th>

          <th class="text-center text-nowrap sort-header">Jami summa</th>

          <th class="text-center text-nowrap sort-header">To'langan</th>

          <th class="text-center text-nowrap sort-header">Qarz</th>

          <th class="text-center text-nowrap sort-header">Yaratilgan vaqt</th>

          <th class="text-center text-nowrap sort-header">Yopilgan vaqt</th>

          <th class="text-center text-nowrap sort-header"></th>

        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-row let-i="rowIndex">
        <tr>

          <td class="text-center">{{ i + 1 }}</td>

          <td class="text-center">{{ row.cartNumber }}</td>

          <td class="text-center">
            <p-tag
              [value]="row.status"
              [severity]="row.status === 'OPEN' ? 'info' : row.status === 'CLOSED' ? 'success' : 'danger'"
            ></p-tag>
          </td>

          <td class="text-center">
            <p-tag [value]="row.paymentType"></p-tag>
          </td>

          <td class="text-center">
            <p-tag
              [value]="row.paymentStatus"></p-tag>
          </td>

          <td class="text-center">{{ row.totalAmount | number:'1.2-2' }}</td>
          <td class="text-center">{{ row.paidAmount | number:'1.2-2' }}</td>
          <td class="text-center text-red-500 font-bold">{{ row.debtAmount | number:'1.2-2' }}</td>

          <td class="text-center">{{ row.createdAt | date:'dd.MM.yyyy HH:mm' }}</td>
          <td class="text-center">{{ row.closedAt ? (row.closedAt | date:'dd.MM.yyyy HH:mm') : '-' }}</td>

          <td class="text-center">
            <p-menu #actionTable [popup]="true" [model]="getRowActions(row)" appendTo="body">
              <ng-template pTemplate="item" let-item>
                <a
                  pRipple
                  class="flex items-center px-3 p-4 min-w-[250px] rounded-md transition-colors duration-150 cursor-pointer"
                  [ngClass]="item.styleClass"
                  (click)="item.command?.($event)"
                >
                  <i [class]="item.icon + ' mr-2'"></i>
                  <span>{{ item.label }}</span>
                </a>
              </ng-template>
            </p-menu>
            <p-button [text]="true" (click)="actionTable.toggle($event)" icon="pi pi-ellipsis-h"/>
          </td>

        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="10">
            <div class="flex flex-col items-center justify-center p-6 text-gray-500">
              <i class="pi pi-info-circle text-3xl mb-2"></i>
              <span>Savatlar topilmadi</span>
            </div>
          </td>
        </tr>
      </ng-template>

    </p-table>
  }
</p-card>

<p-dialog
  [(visible)]="showCartDetailModal"
  (onShow)="onDialogShown()"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [closable]="true"
  [maximizable]="true"
  [dismissableMask]="true"
  [style]="{ minWidth: '50rem'}"
  #dialog
  [baseZIndex]="10000"
  (onHide)="loadData()"
>

  <!-- ===================== HEADER ===================== -->
  <ng-template #header>
    <div class="text-center w-full py-2">
      <span class="text-2xl font-semibold">Savat tafsilotlari</span>
    </div>
  </ng-template>


  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4">


    <!-- ================= LEFT PANEL: CART ITEMS ================= -->
    <div class="md:col-span-2 space-y-4">

      <div class="flex items-center justify-between mb-2">
        <h2 class="text-xl font-semibold">Mahsulotlar</h2>
        <p-badge value="{{ cartItems?.length }}" severity="info"></p-badge>
      </div>


      <p-dataView [value]="cartItems">
        <ng-template #list let-items>

          <div class="space-y-3">

            @for (item of items; track item.cartItemId) {

              <div
                class="flex flex-col bg-white dark:bg-gray-900 rounded-lg border border-gray-200
                 dark:border-gray-700 shadow-sm p-3 gap-2"
              >

                <!-- TITLE + TOTAL -->
                <div class="flex justify-between items-start">
                  <h3 class="text-base font-semibold leading-tight w-2/3">
                    {{ item.itemName }}
                  </h3>

                  <span class="text-blue-600 font-bold text-base whitespace-nowrap">
              {{ item.lineTotal | number:'1.2-2' }}
            </span>
                </div>

                <!-- QUANTITY + PRICE INLINE -->
                <div class="grid grid-cols-2 gap-2 text-sm">

                  <!-- Quantity -->
                  <div class="text-gray-700">
                    Sarflangan miqdor:
                    <span class="font-semibold">{{ item.quantity }}</span>

                    @if (item.altUnitName) {
                      <span class="text-gray-500">
                  ({{ item.altQuantity }} {{ item.altUnitName }})
                </span>
                    }
                  </div>

                  <!-- Unit Price -->
                  <div class="text-gray-700 text-right">
                    Sotuv narxi:
                    <span class="font-semibold">{{ item.unitPrice | number:'1.2-2' }}</span>
                  </div>

                </div>

                <!-- EXTRA INFO — icon badges instead of full text -->
                <div class="flex flex-wrap gap-2 mt-1 text-xs text-gray-600">

                  @if (item.salePrice) {
                    <span class="px-2 py-1 bg-red-50 dark:bg-red-900/20 rounded-md">
                Asl: <span class="line-through text-red-500">{{ item.salePrice | number:'1.2-2' }}</span>
              </span>
                  }

                  @if (item.minimalSum) {
                    <span class="px-2 py-1 bg-yellow-50 dark:bg-yellow-900/20 rounded-md">
                Min: <b>{{ item.minimalSum | number:'1.2-2' }}</b>
              </span>
                  }

                  @if (item.purchasePrice) {
                    <span class="px-2 py-1 bg-blue-50 dark:bg-blue-900/20 rounded-md">
                Xarid: <b>{{ item.purchasePrice | number:'1.2-2' }}</b>
              </span>
                  }

                  @if (item.purchaseDiscount) {
                    <span class="px-2 py-1 bg-green-50 dark:bg-green-900/20 rounded-md text-green-700">
                Chegirma: {{ item.purchaseDiscount }}
              </span>
                  }

                  @if (item.saleDiscount) {
                    <span class="px-2 py-1 bg-red-50 dark:bg-red-900/20 rounded-md text-red-600">
                Kassir: {{ item.saleDiscount }}
              </span>
                  }

                  @if (item.altSalePrice) {
                    <span class="px-2 py-1 bg-purple-50 dark:bg-purple-900/20 rounded-md">
                Qo'shimcha birlik uchun narx: {{ item.altSalePrice | number:'1.2-2' }}
              </span>
                  }

                </div>

              </div>

            }

          </div>

        </ng-template>
      </p-dataView>


    </div>


    <!-- ================= RIGHT PANEL: CART INFO + PAYMENTS ================= -->
    <div class="md:col-span-1 flex flex-col gap-4">

      <!-- CART SESSION INFO -->
      <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-700 shadow p-4">

        <!-- Title + Cart Number -->
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-base font-semibold">Savat haqida</h2>
          <span class="text-sm text-gray-500 font-medium">
      № {{ cartSessionSelectedModel?.cartNumber }}
    </span>
        </div>

        <!-- Statuses -->
        <div class="flex justify-between text-sm mb-3">
          <div>
            <span class="text-gray-600">Holati:</span>
            <p-tag
              styleClass="ml-1"
              [value]="cartSessionSelectedModel?.status"
              [severity]="cartSessionSelectedModel?.status === 'OPEN' ? 'info' : 'success'"
            ></p-tag>
          </div>

          <div>
            <span class="text-gray-600">To‘lov:</span>
            <p-tag
              styleClass="ml-1"
              [value]="cartSessionSelectedModel?.paymentStatus"
            ></p-tag>
          </div>
        </div>

        <!-- Amounts -->
        <div class="grid grid-cols-2 gap-2 text-sm">

          <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded-md">
            <span>Jami:</span>
            <span class="font-semibold text-blue-600">
        {{ cartSessionSelectedModel?.totalAmount | number:'1.2-2' }}
      </span>
          </div>

          <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded-md">
            <span>To‘langan:</span>
            <span class="font-semibold text-green-600">
        {{ cartSessionSelectedModel?.paidAmount | number:'1.2-2' }}
      </span>
          </div>

          <div class="col-span-2 flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded-md">
            <span>Qarz:</span>
            <span class="font-semibold text-red-600">
        {{ cartSessionSelectedModel?.debtAmount | number:'1.2-2' }}
      </span>
          </div>

        </div>

      </div>

      <!-- CUSTOMER INFO -->
      @if (cartCustomer ) {
        <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-700 shadow p-4">

          <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
            <i class="pi pi-user text-blue-600"></i>
            Mijoz haqida
          </h2>

          <div class="space-y-2 text-sm text-gray-700">

            <div class="flex justify-between">
              <span>To‘liq ism:</span>
              <span class="font-medium">{{ cartCustomer.fullName }}</span>
            </div>

            @if (cartCustomer.phoneNumber) {
              <div class="flex justify-between">
                <span>Telefon:</span>
                <span class="font-medium">{{ cartCustomer.phoneNumber }}</span>
              </div>
            }

            @if (cartCustomer.tin) {
              <div class="flex justify-between">
                <span>STIR / PINFL:</span>
                <span class="font-medium">{{ cartCustomer.tin }}</span>
              </div>
            }

            @if (cartCustomer.address) {
              <div>
                <span class="text-gray-600">Manzil:</span>
                <p class="font-medium mt-1">{{ cartCustomer.address }}</p>
              </div>
            }

            @if (cartCustomer.loyaltyPoints) {
              <div class="flex justify-between">
                <span>Loyalty ballari:</span>
                <span class="font-semibold text-blue-600">
            {{ cartCustomer.loyaltyPoints }}
          </span>
              </div>
            }

          </div>

        </div>
      }

      <!-- REFERRER INFO -->
      @if (cartReferrer ) {
        <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-700 shadow p-4">

          <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
            <i class="pi pi-users text-green-600"></i>
            Xamkor (Referent)
          </h2>

          <div class="space-y-2 text-sm text-gray-700">

            <div class="flex justify-between">
              <span>Ism / Tashkilot:</span>
              <span class="font-medium">{{ cartReferrer.fullName }}</span>
            </div>

            <div class="flex justify-between">
              <span>Xamkor kodi:</span>
              <span class="font-semibold">{{ cartReferrer.referrerCode }}</span>
            </div>

            @if (cartReferrer.phone) {
              <div class="flex justify-between">
                <span>Telefon:</span>
                <span class="font-medium">{{ cartReferrer.phone }}</span>
              </div>
            }

            <div class="flex justify-between">
              <span>Bonus balansi:</span>
              <span class="font-bold text-purple-600">
          {{ cartReferrer.balance | number:'1.0-0' }}
        </span>
            </div>

          </div>

        </div>
      }

      <!-- PAYMENT LIST -->
      <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-700 shadow p-4">

        <h2 class="text-lg font-semibold mb-3">To‘lovlar</h2>

        <p-listbox
          [options]="cartPayments || []"
          optionLabel="method"
          class="w-full"
        >
          <ng-template let-pay #item>

            <div class="py-2">

              <div class="flex justify-between items-center">
                <p-tag [value]="pay.method" severity="info"></p-tag>

                <span class="text-green-700 font-semibold text-lg">
                  {{ pay.amount | number:'1.2-2' }}
                </span>
              </div>

              @if (pay.externalTxnId){
                <div class="text-xs text-gray-500 mt-1">
                  Tranzaksiya ID: {{ pay.externalTxnId }}
                </div>
              }

              @if (pay.paidAt){
                <div class="text-xs text-gray-500">
                  {{ pay.paidAt | date:'dd.MM.yyyy HH:mm' }}
                </div>
              }

            </div>

          </ng-template>
        </p-listbox>

      </div>

    </div>


  </div>

</p-dialog>
